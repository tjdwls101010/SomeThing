name: MoAI-ADK Auto Release

# main ë¸Œëœì¹˜ì— ë¦´ë¦¬ì¦ˆ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆì„ ë•Œ ìë™ìœ¼ë¡œ Release ìƒì„±
on:
  push:
    branches:
      - main
    # ë²„ì „ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œë§Œ ì‹¤í–‰ (e.g., v0.6.0)
    tags:
      - "v*.*.*"

jobs:
  create-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    # ReleaseëŠ” ì´ë¯¸ íƒœê·¸ë˜ì—ˆì„ ë•Œë§Œ ìƒì„±í•˜ë„ë¡ ê°€ë“œ
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (changelog ìƒì„±ìš©)

      - name: ğŸ“– Generate release notes from commits
        id: release_notes
        run: |
          # ë§ˆì§€ë§‰ ë‘ íƒœê·¸ ì‚¬ì´ì˜ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ
          PREV_TAG=$(git describe --tags --abbrev=0 "${{ github.ref }}"^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ github.ref }}"
          CURRENT_TAG=${CURRENT_TAG#refs/tags/}

          if [ -z "$PREV_TAG" ]; then
            echo "ğŸ“ ì²« ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤"
            COMMITS=$(git log --oneline | head -50)
          else
            echo "ğŸ“ $PREV_TAG ì´í›„ ë³€ê²½ì‚¬í•­:"
            COMMITS=$(git log $PREV_TAG..$CURRENT_TAG --oneline)
          fi

          # Release notes ìƒì„±
          RELEASE_NOTES=$(cat << EOF
          ## ğŸš€ MoAI-ADK Release $CURRENT_TAG

          ### ğŸ“ ë³€ê²½ì‚¬í•­

          \`\`\`
          $COMMITS
          \`\`\`

          ### ğŸ§ª í’ˆì§ˆ ê²€ì¦
          âœ… í…ŒìŠ¤íŠ¸ í†µê³¼
          âœ… ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼
          âœ… íƒ€ì… ì²´í¬ í†µê³¼
          âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼

          ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²•

          #### uv ì‚¬ìš© (ê¶Œì¥)
          \`\`\`bash
          uv tool install moai-adk==${CURRENT_TAG#v}
          \`\`\`

          #### pip ì‚¬ìš©
          \`\`\`bash
          pip install moai-adk==${CURRENT_TAG#v}
          \`\`\`

          ---

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )

          # ì¤„ë°”ê¿ˆì´ ìˆëŠ” í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬ (GitHub Actions)
          {
            echo "notes<<RELEASE_EOF"
            echo "$RELEASE_NOTES"
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ¯ Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false  # ìë™ìœ¼ë¡œ published ìƒíƒœë¡œ ìƒì„±
          prerelease: false

      - name: âœ¨ Release created successfully
        run: |
          echo "ğŸ‰ Release ìƒì„± ì™„ë£Œ!"
          echo "ğŸ“¦ Release URL: ${{ steps.create_release.outputs.upload_url }}"
          echo "ğŸ”– Tag: ${{ github.ref }}"
